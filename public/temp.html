<!DOCTYPE html>
<html lang="id">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Imelin | Inbox Pribadi Modern</title>
	<!-- Bootstrap 5 CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Google Fonts: Poppins -->
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
		rel="stylesheet">
	<!-- Lucide Icons -->
	<script src="https://unpkg.com/lucide@latest"></script>
	<style>
		:root {
			--yahoo-purple: #6001d2;
			--yahoo-purple-hover: #5000b0;
			--yahoo-bg: #f6f8fa;
			--yahoo-border: #e0e4e9;
			--text-main: #26282a;
			--text-sub: #626971;
		}

		body {
			background-color: var(--yahoo-bg);
			font-family: 'Poppins', sans-serif;
			color: var(--text-main);
			overflow-x: hidden;
			margin: 0;
			padding: 0;
		}

		/* Modern Navbar & Responsive Header */
		.navbar {
			background-color: white;
			border-bottom: 1px solid var(--yahoo-border);
			padding: 0.6rem 1rem;
			height: 60px;
		}

		.navbar-brand {
			font-weight: 800;
			color: var(--yahoo-purple) !important;
			font-size: 1.3rem;
			letter-spacing: -1px;
			display: flex;
			align-items: center;
		}

		.btn-refresh-top {
			background: var(--yahoo-purple);
			color: white;
			border: none;
			border-radius: 50%;
			width: 36px;
			height: 36px;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: transform 0.3s ease;
		}

		.btn-refresh-top:active {
			transform: rotate(180deg);
		}

		/* Layout */
		.app-container {
			display: flex;
			min-height: calc(100vh - 60px);
		}

		.sidebar {
			width: 240px;
			background: white;
			border-right: 1px solid var(--yahoo-border);
			padding: 1.5rem 1rem;
			display: none;
		}

		@media (min-width: 992px) {
			.sidebar {
				display: block;
			}
		}

		.main-content {
			flex-grow: 1;
			padding: 12px;
			width: 100%;
			max-width: 800px;
			margin: 0 auto;
		}

		/* Generator Card - Responsive Tweak */
		.card-modern {
			background: white;
			border: 1px solid var(--yahoo-border);
			border-radius: 16px;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
			margin-bottom: 1.5rem;
			padding: 16px;
		}

		.email-label {
			font-size: 0.75rem;
			font-weight: 700;
			color: var(--text-sub);
			text-transform: uppercase;
			margin-bottom: 10px;
			display: block;
		}

		.email-box-container {
			background: #f0f4f8;
			border-radius: 12px;
			padding: 12px 16px;
			margin-bottom: 12px;
			text-align: center;
			border: 1px solid transparent;
			transition: border-color 0.2s;
		}

		.email-text {
			font-size: 1rem;
			font-weight: 600;
			color: var(--yahoo-purple);
			word-break: break-all;
		}

		.btn-action-group {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 10px;
		}

		.btn-yahoo {
			background-color: var(--yahoo-purple);
			color: white;
			border-radius: 12px;
			padding: 10px;
			font-weight: 600;
			border: none;
			font-size: 0.9rem;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.btn-yahoo:hover {
			background-color: var(--yahoo-purple-hover);
		}

		.btn-yahoo-outline {
			background: white;
			border: 1px solid var(--yahoo-border);
			border-radius: 12px;
			padding: 10px;
			font-weight: 600;
			color: var(--text-main);
			font-size: 0.9rem;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		/* Inbox Style */
		.section-title {
			font-size: 1.1rem;
			font-weight: 700;
			margin-bottom: 12px;
			padding-left: 4px;
			display: flex;
			align-items: center;
		}

		.inbox-card {
			background: white;
			border: 1px solid var(--yahoo-border);
			border-radius: 16px;
			overflow: hidden;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
		}

		.email-item {
			display: flex;
			padding: 14px 16px;
			border-bottom: 1px solid var(--yahoo-border);
			cursor: pointer;
			align-items: center;
			position: relative;
		}

		.email-item:last-child {
			border-bottom: none;
		}

		.email-item:hover {
			background-color: #f8faff;
		}

		.email-item.unread {
			background-color: white;
			border-left: 4px solid var(--yahoo-purple);
		}

		.email-item.read {
			background-color: #fafbfc;
			opacity: 0.85;
			border-left: 4px solid transparent;
		}

		.sender-avatar {
			width: 44px;
			height: 44px;
			border-radius: 12px;
			/* Square rounded ala Yahoo modern */
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			font-weight: 700;
			flex-shrink: 0;
			margin-right: 12px;
			font-size: 1.1rem;
		}

		.email-content-box {
			flex-grow: 1;
			min-width: 0;
		}

		.email-meta {
			display: flex;
			justify-content: space-between;
			align-items: baseline;
			margin-bottom: 2px;
		}

		.sender-name {
			font-weight: 700;
			font-size: 0.9rem;
			color: var(--text-main);
		}

		.email-time {
			font-size: 0.7rem;
			color: var(--text-sub);
			white-space: nowrap;
		}

		.email-subject {
			font-size: 0.85rem;
			font-weight: 600;
			margin-bottom: 2px;
		}

		.unread .email-subject {
			color: #000;
		}

		.read .email-subject {
			color: var(--text-main);
			font-weight: 500;
		}

		.email-preview {
			font-size: 0.8rem;
			color: var(--text-sub);
			display: -webkit-box;
			-webkit-line-clamp: 1;
			-webkit-box-orient: vertical;
			overflow: hidden;
		}

		/* Toast */
		#statusMessage {
			position: fixed;
			bottom: 20px;
			left: 50%;
			transform: translateX(-50%);
			z-index: 11000;
			background: #222;
			color: white;
			padding: 8px 20px;
			border-radius: 10px;
			font-size: 0.85rem;
			display: none;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
		}

		/* Modal Responsive */
		.modal-content {
			border-radius: 20px;
			border: none;
		}

		.modal-header {
			border-bottom: 1px solid #eee;
			padding: 15px 20px;
		}

		.modal-body {
			padding: 20px;
		}

		#messageBodyContent {
			font-size: 0.9rem;
			line-height: 1.6;
			color: #444;
		}

		#messageBodyContent img {
			max-width: 100%;
			height: auto;
			border-radius: 8px;
		}

		@media (max-width: 576px) {
			.main-content {
				padding: 10px;
			}

			.card-modern {
				padding: 12px;
				border-radius: 12px;
			}

			.email-item {
				padding: 12px;
			}

			.sender-avatar {
				width: 40px;
				height: 40px;
				font-size: 1rem;
			}
		}
	</style>
</head>

<body>

	<nav class="navbar sticky-top">
		<div class="container-fluid">
			<a class="navbar-brand" href="#">
				<i data-lucide="mail" class="me-2" style="width: 24px; height: 24px;"></i>
				Imelin
			</a>
			<div class="d-flex align-items-center">
				<div id="refreshIndicator" class="text-muted small me-2 d-none d-md-block">
					<span class="spinner-grow spinner-grow-sm text-success me-1" style="width: 8px; height: 8px;"></span>
					Live
				</div>
				<button class="btn-refresh-top" onclick="fetchMessages()" title="Segarkan Manual">
                <i data-lucide="rotate-cw" style="width: 18px; height: 18px;"></i>
            </button>
			</div>
		</div>
	</nav>

	<div class="app-container">
		<aside class="sidebar">
			<nav class="nav flex-column">
				<a class="nav-link active" href="#"><i data-lucide="inbox"></i> Inbox</a>
				<a class="nav-link" href="#"><i data-lucide="star"></i> Berbintang</a>
				<a class="nav-link" href="#"><i data-lucide="archive"></i> Arsip</a>
				<a class="nav-link" href="#"><i data-lucide="trash-2"></i> Sampah</a>
			</nav>
		</aside>

		<main class="main-content">
			<!-- Generator Card -->
			<div class="card card-modern">
				<span class="email-label">Alamat Email Sementara Anda</span>
				<div class="email-box-container">
					<span id="currentEmail" class="email-text">Menyiapkan...</span>
					<input type="text" id="copyBuffer" style="position: absolute; left: -9999px;">
            </div>
					<div class="btn-action-group">
						<button class="btn-yahoo" onclick="copyEmail()">
                    <i data-lucide="copy" class="me-2" style="width: 16px;"></i> Salin
                </button>
						<button id="btnGenerate" class="btn-yahoo-outline" onclick="handleGenerateNew()">
                    <i data-lucide="shuffle" class="me-2" style="width: 16px;"></i> Ganti
                </button>
					</div>
				</div>

				<!-- Inbox Header -->
				<div class="section-title">
					Inbox
					<span id="msgCountBadge" class="badge rounded-pill bg-light text-dark border ms-2" style="display:none; font-size: 0.7rem;">0</span>
				</div>

				<div id="loader" class="text-center py-4" style="display: none;">
					<div class="spinner-border text-primary spinner-border-sm" role="status"></div>
				</div>

				<!-- Email List -->
				<div id="emailList" class="inbox-card"></div>

				<!-- Empty State -->
				<div id="emptyState" class="text-center py-5 d-none">
					<div class="mb-3 text-muted opacity-25">
						<i data-lucide="inbox" style="width: 64px; height: 64px;"></i></div>
					<h6 class="text-dark fw-bold">Kotak masuk kosong</h6>
					<p class="text-muted small">Menunggu email baru datang...</p>
				</div>

				<div class="text-center mt-3">
					<span id="lastUpdated" class="text-muted" style="font-size: 0.65rem;">Sinkronisasi...</span>
				</div>
		</main>
	</div>

	<!-- Custom Toast -->
	<div id="statusMessage">Tersalin!</div>

	<!-- Modal Detail Dialog -->
	<div class="modal fade" id="emailModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-fullscreen-sm-down modal-lg modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<div class="d-flex align-items-center w-100">
						<button type="button" class="btn btn-light btn-sm me-3 d-sm-none" data-bs-dismiss="modal">
                        <i data-lucide="arrow-left" style="width: 18px;"></i>
                    </button>
						<h6 class="modal-title fw-bold text-truncate flex-grow-1" id="modalSubject"
							style="font-size: 1rem;">Memuat...</h6>
						<button type="button" class="btn-close d-none d-sm-block" data-bs-dismiss="modal"></button>
					</div>
				</div>
				<div class="modal-body">
					<div class="d-flex align-items-center mb-4">
						<div id="modalAvatar" class="sender-avatar me-3" style="background-color: var(--yahoo-purple);">
							?</div>
						<div class="flex-grow-1 overflow-hidden">
							<div class="fw-bold text-dark text-truncate" id="modalFrom" style="font-size: 0.95rem;">Nama
								Pengirim</div>
							<div class="text-muted small text-truncate" id="modalFromAddress"
								style="font-size: 0.8rem;">sender@domain.com</div>
						</div>
					</div>
					<div id="messageBodyContent">
						<div class="text-center py-5">
							<div class="spinner-border text-primary spinner-border-sm"></div>
						</div>
					</div>
				</div>
				<div class="modal-footer py-2">
					<button type="button" class="btn btn-light btn-sm px-4" data-bs-dismiss="modal">Tutup</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Bootstrap JS -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

	<script type="module">
		const API_TOKEN = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzUxMiJ9.eyJpYXQiOjE3NzE2NjA3NDIsInJvbGVzIjpbIlJPTEVfVVNFUiJdLCJhZGRyZXNzIjoic29udGVuQGRvbGxpY29ucy5jb20iLCJpZCI6IjY5OTk2NWM2ZGI0NDg0MzMwZDBjMGZkYiIsIm1lcmN1cmUiOnsic3Vic2NyaWJlIjpbIi9hY2NvdW50cy82OTk5NjVjNmRiNDQ4NDMzMGQwYzBmZGIiXX19.rztbinmF0DYdnRQVQA3oBccA3ff4ir1jVfIGkawl0S0uZJQGVf-URsFLVXqOkhNDZ8uPOdy4-cS5m1kUwMLibw';
    const API_BASE = 'https://api.mail.tm';
    const DEFAULT_DOMAIN = 'sonten.web.id';

    // Icons
    lucide.createIcons();

    let emailModalInstance = null;

    async function initApp() {
        try {
            const modalEl = document.getElementById('emailModal');
            if (typeof bootstrap !== 'undefined') {
                emailModalInstance = new bootstrap.Modal(modalEl);
            }
        } catch (err) { console.error(err); }

        const storedEmail = localStorage.getItem('imelin_email');
        const storedMessages = localStorage.getItem('imelin_messages');

        if (storedEmail) {
            document.getElementById('currentEmail').innerText = storedEmail;
            if (storedMessages) {
                renderMessages(JSON.parse(storedMessages));
            }
            await fetchMessages();
        } else {
            await handleGenerateNew();
        }

        // Auto Refresh 5s
        setInterval(fetchMessages, 5000);
    }

    async function handleGenerateNew() {
        const btn = document.getElementById('btnGenerate');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        await deleteAllMessagesFromAPI();
        
        const names = ['budi', 'siti', 'andi', 'rudi', 'lina', 'dewi', 'fajar', 'eka', 'bayu', 'putri', 'agus', 'indra', 'maya', 'dani', 'sari', 'ari', 'dina', 'rizky', 'nana', 'joni', 'bagus', 'yoga', 'dimas'];
        const randomName = names[Math.floor(Math.random() * names.length)];
        const email = `${randomName}${Math.floor(1000 + Math.random() * 9000)}@${DEFAULT_DOMAIN}`;
        
        localStorage.setItem('imelin_email', email);
        localStorage.removeItem('imelin_messages');
        
        document.getElementById('currentEmail').innerText = email;
        document.getElementById('emailList').innerHTML = '';
        await fetchMessages();

        btn.disabled = false;
        btn.innerHTML = '<i data-lucide="shuffle" class="me-2" style="width: 16px;"></i> Ganti';
        lucide.createIcons();
        showStatus('Email baru disiapkan!');
    }

    async function deleteAllMessagesFromAPI() {
        try {
            const res = await fetch(`${API_BASE}/messages`, {
                headers: { 'Authorization': `Bearer ${API_TOKEN}` }
            });
            const data = await res.json();
            const msgs = data['hydra:member'] || [];
            if (msgs.length === 0) return;
            await Promise.all(msgs.map(m => fetch(`${API_BASE}/messages/${m.id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${API_TOKEN}` }
            })));
        } catch (e) { console.error(e); }
    }

    async function fetchMessages() {
        try {
            const res = await fetch(`${API_BASE}/messages?page=1`, {
                headers: { 'accept': 'application/ld+json', 'Authorization': `Bearer ${API_TOKEN}` }
            });
            if (!res.ok) return;
            const data = await res.json();
            const msgs = data['hydra:member'] || [];
            localStorage.setItem('imelin_messages', JSON.stringify(msgs));
            renderMessages(msgs);
            document.getElementById('lastUpdated').innerText = 'DIPERBARUI: ' + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
        } catch (err) { console.error(err); }
    }

    function renderMessages(msgs) {
        const list = document.getElementById('emailList');
        const empty = document.getElementById('emptyState');
        const badge = document.getElementById('msgCountBadge');
        
        list.innerHTML = '';
        if (msgs.length > 0) {
            empty.classList.add('d-none');
            badge.innerText = msgs.length;
            badge.style.display = 'inline-block';
            
            msgs.forEach(m => {
                const item = document.createElement('div');
                item.className = `email-item ${m.seen ? 'read' : 'unread'}`;
                item.onclick = () => showDetail(m.id);

                const name = m.from.name || m.from.address;
                const initial = name.charAt(0).toUpperCase();
                const colors = ['#6001d2', '#2d333a', '#d93025', '#188038', '#f29900'];
                const avatarColor = colors[initial.charCodeAt(0) % 5];
                
                item.innerHTML = `
                    <div class="sender-avatar" style="background-color: ${avatarColor}">${initial}</div>
                    <div class="email-content-box">
                        <div class="email-meta">
                            <span class="sender-name text-truncate">${name}</span>
                            <span class="email-time">${formatDate(m.createdAt)}</span>
                        </div>
                        <div class="email-subject text-truncate">${m.subject || '(Tanpa Subjek)'}</div>
                        <div class="email-preview">${m.intro}</div>
                    </div>
                `;
                list.appendChild(item);
            });
        } else {
            empty.classList.remove('d-none');
            badge.style.display = 'none';
        }
    }

    async function showDetail(id) {
        if (!emailModalInstance) return;
        document.getElementById('modalSubject').innerText = "Memuat...";
        document.getElementById('messageBodyContent').innerHTML = `<div class="text-center py-5"><div class="spinner-border text-primary spinner-border-sm"></div></div>`;
        emailModalInstance.show();

        try {
            const res = await fetch(`${API_BASE}/messages/${id}`, {
                headers: { 'accept': 'application/ld+json', 'Authorization': `Bearer ${API_TOKEN}` }
            });
            const m = await res.json();
            document.getElementById('modalSubject').innerText = m.subject || '(Tanpa Subjek)';
            document.getElementById('modalFrom').innerText = m.from.name || 'Pengirim';
            document.getElementById('modalFromAddress').innerText = m.from.address;
            document.getElementById('modalAvatar').innerText = (m.from.name || m.from.address).charAt(0).toUpperCase();
            document.getElementById('messageBodyContent').innerHTML = (m.html && m.html.length > 0) ? m.html[0] : `<pre style="white-space: pre-wrap; font-family: inherit;">${m.text}</pre>`;
            fetchMessages();
        } catch (e) {
            document.getElementById('messageBodyContent').innerHTML = 'Error.';
        }
    }

    function formatDate(str) {
        const d = new Date(str);
        const now = new Date();
        const diff = Math.floor((now - d) / 1000);
        if (diff < 60) return 'Baru';
        if (diff < 3600) return Math.floor(diff / 60) + 'm';
        return d.toDateString() === now.toDateString() ? d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : d.toLocaleDateString([], { day: '2-digit', month: 'short' });
    }

    window.copyEmail = () => {
        const txt = document.getElementById('currentEmail').innerText;
        const input = document.getElementById('copyBuffer');
        input.value = txt;
        input.select();
        document.execCommand('copy');
        showStatus('Tersalin!');
    };

    window.handleGenerateNew = handleGenerateNew;
    window.fetchMessages = fetchMessages;

    function showStatus(text) {
        const msg = document.getElementById('statusMessage');
        msg.innerText = text;
        msg.style.display = 'block';
        setTimeout(() => { msg.style.display = 'none'; }, 2000);
    }

    window.onload = initApp;
</script>
</body>

</html>
